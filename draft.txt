"""
Test PostgreSQL connection - Multiple methods
Run this after starting docker-compose
"""
import os
import psycopg
# Set environment variables - UPDATED to match current docker-compose.yml
os.environ['DB_HOST'] = 'localhost'
os.environ['DB_PORT'] = '5432'
os.environ['DB_NAME'] = 'etldb'  # Changed from covid_etl
os.environ['DB_USER'] = 'postgres'  # Changed from etl_user
os.environ['DB_PASSWORD'] = ''  # No password (trust auth)
os.environ['DB_SCHEMA'] = 'public'  # Changed from covid_data

print("üîç Testing PostgreSQL Connection...\n")

# Method 1: Using psycopg2 (raw connection)
print("=" * 60)
print("Method 1: psycopg2 (Raw SQL)")
print("=" * 60)
try:
    import psycopg2
    
    conn = psycopg2.connect(
        host="localhost",
        port=5432,
        database="etldb",
        user="postgres",
        password=""
    )
    
    cursor = conn.cursor()
    
    # Test query
    cursor.execute("SELECT version();")
    version = cursor.fetchone()
    print(f"‚úÖ Connected! PostgreSQL version:")
    print(f"   {version[0][:80]}...")
    
    # Check tables
    cursor.execute("""
        SELECT table_name 
        FROM information_schema.tables 
        WHERE table_schema = 'public'
        ORDER BY table_name;
    """)
    tables = cursor.fetchall()
    print(f"\nüìä Tables in public schema:")
    for table in tables:
        print(f"   - {table[0]}")
    
    cursor.close()
    conn.close()
    print()
    
except Exception as e:
    print(f"‚ùå Error: {e}\n")


# Method 2: Using psycopg2 connection pool (without db_config.py)
print("=" * 60)
print("Method 2: Connection Pool")
print("=" * 60)
try:
    from psycopg2 import pool
    
    connection_pool = pool.SimpleConnectionPool(
        1, 5,
        host="localhost",
        port=5432,
        database="etldb",
        user="postgres",
        password=""
    )
    
    conn = connection_pool.getconn()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
    count = cursor.fetchone()[0]
    print(f"‚úÖ Connection pool working!")
    print(f"   Found {count} tables in public schema\n")
    cursor.close()
    connection_pool.putconn(conn)
    connection_pool.closeall()
    
except Exception as e:
    print(f"‚ùå Error: {e}\n")


# Method 3: Using SQLAlchemy (for pandas)
print("=" * 60)
print("Method 3: SQLAlchemy (For Pandas)")
print("=" * 60)
try:
    from sqlalchemy import create_engine, text
    import pandas as pd
    
    engine = create_engine(
        "postgresql://postgres@localhost:5432/etldb"
    )
    
    # Test with a simple query
    with engine.connect() as conn:
        result = conn.execute(text("SELECT current_database(), current_schema();"))
        db, schema = result.fetchone()
        print(f"‚úÖ SQLAlchemy connected!")
        print(f"   Database: {db}")
        print(f"   Schema: {schema}")
    
    # Test with pandas
    df = pd.read_sql("SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' LIMIT 5", engine)
    print(f"\nüìä Tables (via pandas):")
    print(df.to_string(index=False))
    print()
    
except Exception as e:
    print(f"‚ùå Error: {e}\n")


# Method 4: Insert test data
print("=" * 60)
print("Method 4: Test Insert & Query")
print("=" * 60)
try:
    import psycopg2
    from datetime import datetime
    
    conn = psycopg2.connect(
        host="localhost",
        port=5432,
        database="etldb",
        user="postgres",
        password=""
    )
    
    cursor = conn.cursor()
    
    # Create a simple test table
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS test_etl (
            id SERIAL PRIMARY KEY,
            process_name VARCHAR(100),
            records_processed INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        );
    """)
    conn.commit()
    
    # Insert test data
    cursor.execute("""
        INSERT INTO test_etl (process_name, records_processed)
        VALUES (%s, %s)
        RETURNING id;
    """, ('test_connection', 100))
    
    test_id = cursor.fetchone()[0]
    conn.commit()
    
    print(f"‚úÖ Inserted test record with ID: {test_id}")
    
    # Query it back
    cursor.execute("SELECT * FROM test_etl WHERE id = %s;", (test_id,))
    result = cursor.fetchone()
    print(f"   Retrieved: process_name='{result[1]}', records={result[2]}")
    
    # Clean up test data
    cursor.execute("DROP TABLE test_etl;")
    conn.commit()
    print(f"   Cleaned up test table\n")
    
    cursor.close()
    conn.close()
    
except Exception as e:
    print(f"‚ùå Error: {e}\n")


print("=" * 60)
print("‚ú® All connection tests completed!")
print("=" * 60)
print("\nüìù Connection Details:")
print(f"   Host: localhost")
print(f"   Port: 5432")
print(f"   Database: etldb")
print(f"   User: postgres")
print(f"   Password: (none - trust auth)")
print(f"   Schema: public")
print("\nüîå Connect via CLI:")
print(f"   docker exec -it etl_postgres psql -U postgres -d etldb")

